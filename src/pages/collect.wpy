<style lang="less">
page {
  background: url(http://ovhvevt35.bkt.clouddn.com/NightSong/list_bg.png);
  background-size: 100% 100%;
}

.week {
  width: 100%;
  color: #fff;
  padding-top: 50rpx;
  text-align: center;
}

.song_name {
  color: #fff;
  font-size: 37rpx;
  text-align: center;
  margin-bottom: 34rpx;
  border-bottom: 1px solid #fff;
  display: inline-block;
  position: relative;
  left: 50%;
  transform: translateX(-50%);
}

.song_list {
  width: 540rpx;
  height: 745rpx;
  background: rgba(255, 255, 255, 0.5);
  margin: 0 auto;
  border-radius: 20rpx;
  .title {
    font-size: 30rpx;
    text-align: center;
    padding: 30rpx 0;
    color: #fff;
    margin-bottom: 20rpx;
    border-bottom: 1px solid #fff;
  }
  .song_view {
    width: 100%;
    padding: 0 30rpx;
    .song_item {
      font-size: 24rpx;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      .name {
        color: #fff;
        font-size: 24rpx;
        width: 400rpx;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
      }
      view:nth-of-type(2) {
        font-size: 24rpx;
      }
      .option {
        width: 40rpx;
        height: 40rpx;
        margin-left: 20rpx;
        display: flex;
        justify-content: center;
        align-items: center;
        image {
          width: 36rpx;
          height: 36rpx;
        }
      }
      .delete {
        width: 40rpx;
        height: 40rpx;
        background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoBAMAAAB+0KVeAAAAHlBMVEUAAAD///////////////////////////////////8kfJuVAAAACXRSTlMAEPDQMGCgUCC7NeMFAAAAaklEQVQoz2MYBQxiAjACARgtDSEEMmDRnCzAIDxTBVW700xDRstJDgzoSpsRChFKZyIUIpRCFKLZP9MQXQxo9czJAhgKJwWhKwW5EexWZAB2oxOaUnaQ1Sya01G1BzmA3BqAZhGEGAVYAQDeXxVFdrnW1gAAAABJRU5ErkJggg==");
        background-size: 100% 100%;
      }
    }
  }
}
.option_btn {
  display: flex;
  justify-content: space-between;
  width: 100%;
  padding: 0 150rpx;
  margin-bottom: 46rpx;
  view {
    width: 40rpx;
    height: 40rpx;
    image {
      display: block;
      width: 40rpx;
      height: 40rpx;
    }
  }
}
</style>

<template>
  <view>
      <view class="week">{{todayWeek}}</view>
      <view class="song_name">{{currentSong.name}}</view>
      <!-- 控制区 -->
           <view class="option_btn">
             <view class="collect">
                 <image  @tap="collectSong({{currentSong.id}})" wx:if="{{currentSong.collected=='0'}}" src="https://qncdn.playonwechat.com/NightSong/index__icon_collect.png"></image>
                 <image wx:else @tap="discollectSong({{currentSong.id}})" src="https://qncdn.playonwechat.com/NightSong/index__icon_has_collect.png"></image>
             </view>
             <view class="prev" @tap="prevMusic">
                 <image src="https://qncdn.playonwechat.com/NightSong/index__icon_prev_song.png"></image>
             </view>
             <view class="play">
                 <image wx:if="{{currentSong.playing=='0'?true:false}}" @tap="audioPlay()" src="https://qncdn.playonwechat.com/NightSong/index__icon_play.png"></image>
                 <image wx:else  @tap="audioPause()" src="https://qncdn.playonwechat.com/NightSong/index__icon_play_pause.png"></image>
             </view>
             <view class="next" @tap="nextMusic">
                 <image src="https://qncdn.playonwechat.com/NightSong/index__icon_next_song.png"></image>
             </view>
             <view class="cycle">
                 <image wx:if="{{cycleSong}}"  @tap="cycleSong" src="https://qncdn.playonwechat.com/NightSong/index__icon_list_cycle.png"></image>
                 <image   @tap="cycleSong"  wx:else src="https://qncdn.playonwechat.com/NightSong/index__icon_one_cycle.png"></image>
             </view>
         </view>

      <view class="song_list">
           
          <view class="title">我的歌单</view>
          <scroll-view>
             <view class="song_view">
                 <view class="song_item"  wx:for="{{song}}"  @tap="songPlay({{index}})">
                         <view class="name">{{item.name}}</view>
                        <view class="delete" @tap="deleteCollect({{item.id}},{{index}})"></view>
                 </view>
                 <!-- <view>您还没有收藏</view> -->
             </view>
          </scroll-view>
      </view>
    
  </view>
</template>

<script>
import wepy from "wepy";
import api from "../comm/api";
import tip from "../comm/tip";
import myRequest from "../comm/wxRequest";
import playMusic from "../comm/music";
export default class Index extends wepy.page {
  config = {
    navigationBarTitleText: "我的歌单",
    navigationBarBackgroundColor: "#21282e",
    navigationBarTextStyle: "#fff",
    disableScroll: true
  };
  data = {
    song: [],
    currentSong: {}, //当前播放歌曲
    cycleSong:false,
    todayWeek: "", //当前的星期英文单词
    songIndex: {
      index: "",
      list: ""
    } //当前音乐播放的index,当前播放的属于列表
  };

  methods = {
    // 页面列表播放歌曲
    songPlay(idx) {
      let that = this;
      console.log(idx, "idx");
      wx.setStorageSync("idx", idx);
      let song = that.song;
      let _song = that.song[idx];
      playMusic.play(wx.getStorageSync("oldList"), song, true, idx);
      for (let i = 0; i < song.length; i++) {
        song[i].playing = 0;
      }
      that.currentSong = [_song];
      that.song[idx].playing = 1;
      that.songIndex = idx;
      wx.setStorageSync('currentSong',[_song])
      that.$apply();
    },
    // 页面顶部歌曲播放
    audioPlay() {
      let that = this;
      wx.getBackgroundAudioPlayerState({
        success: function(res) {
          if (res.status === 1) {
            //歌曲正在播放，这个时候需要暂停播放
            wx.pauseBackgroundAudio();
          } else if (res.status === 0) {
            //歌曲暂停，这个时候需要播放
            playMusic.play( wx.getStorageSync("oldList"),[],false, wx.getStorageSync("idx"));
            that.currentSong.playing = 1;
            that.$apply();
          }
        },
        fail() {
          //当前没有歌曲播放  播放缓存的歌曲列表
          playMusic.play(wx.getStorageSync("oldList"),[],false,wx.getStorageSync("idx"));
          console.log(1111);
          that.currentSong.playing = 1;
          that.$apply();
        }
      });
    },

    // 页面顶部暂停
    audioPause() {
      let that = this;
      console.log("收藏的页面顶部暂停");
      wx.pauseBackgroundAudio();
      that.currentSong.playing = 0;
      that.$apply();
    },

    // 暂停播放
    songPause(idx) {
      console.log(idx, "idx");
      let that = this;
      idx = idx ? idx : that.songIndex;
      if (idx) {
        this.song[idx].playing = 0;
      }
      this.currentSong.playing = 0;
      wx.pauseBackgroundAudio();
      this.$apply();
    },

    // 取消收藏
    discollectSong(id) {
        let that = this;
      wx.myRequest({ id: that.currentSong.id }, api.disCollect, function(res) {
        console.log(res);
        if (res.statusCode) {
          that.currentSong.collected = 0;
          that.$apply();
          tip.success("取消收藏成功");
        }
      });
    },
    // 收藏
    collectSong(id){
        let that = this;
       wx.myRequest({ id:id }, api.Collect, function(res) {
        console.log(res);
        if (res.statusCode) {
          let currentSong = that.currentSong;
          that.currentSong.collected = 1;
          that.$apply();
          tip.success("收藏成功");
        }
      });
    },
    // 切换歌曲循环模式
    cycleSong(){
      let that = this;
      that.cycleSong = !that.cycleSong;
      playMusic.play(wx.getStorageSync("oldList"),[],false,wx.getStorageSync("idx")+1,that.cycleSong);
    },

    // 在列表内删除
    deleteCollect(id,index){
        let that = this;
       wx.myRequest({ id:id }, api.disCollect, function(res) {
        console.log(res);
        if (res.statusCode) {
          let song = that.song;
              song.splice(index,1)
          that.song = song;
          that.$apply();
          tip.success("取消收藏成功");
        }
      });
    }
  };

  onLoad() {
    let that = this;
    that.todayWeek = wx.getStorageSync("todayWeek");
    that.$apply();
  }

  onShow() {
    let that = this;
    // 获取歌曲播放状态
    console.log("that.currentSong",that.currentSong)
    wx.getBackgroundAudioPlayerState({
      success(res) {
        console.log(res, "这里有没有执行");
        if (res.status == "1") {
          console.log(that.currentSong);
          that.currentSong.playing = 1;
        }
      },
      fail(res) {
        //当前没有歌曲在播放
      }
    });

    wx.myRequest({ page: 0 }, api.myCollect, function(res) {
      that.song = res.data;
      that.$apply();
    });
    let currentSong = wx.getStorageSync("currentSong");
    console.log(currentSong);
    if (currentSong) {
      that.currentSong = currentSong[0];
    }
  }
}
</script>